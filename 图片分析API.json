{
  "info": {
    "title": "epipremnum - 图片分析 API",
    "description": "AI图片分析系统接口文档，支持异步分析、状态查询、结果应用等功能",
    "version": "2.0.0"
  },
  "openapi": "3.0.0",
  "servers": [
    {
      "url": "http://192.168.55.133:8888",
      "description": "生产环境"
    }
  ],
  "paths": {
    "/api/ollama/analyze/single/": {
      "post": {
        "summary": "创建异步分析任务",
        "description": "对指定媒体文件创建AI图片分析任务，支持自定义分析选项",
        "tags": ["图片分析 API"],
        "parameters": [
          {
            "name": "Authorization",
            "in": "header",
            "description": "Bearer token 认证",
            "required": true,
            "example": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "Content-Type",
            "in": "header",
            "description": "请求内容类型",
            "required": true,
            "example": "application/json",
            "schema": {
              "type": "string"
            }
          }
        ],
        "requestBody": {
          "description": "分析请求参数",
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["media_id"],
                "properties": {
                  "media_id": {
                    "type": "integer",
                    "description": "媒体文件ID",
                    "example": 38
                  },
                  "model_name": {
                    "type": "string",
                    "description": "指定模型名称（可选，不指定则使用默认模型）",
                    "example": "qwen3-vl:2b-instruct-bf16"
                  },
                  "options": {
                    "type": "object",
                    "description": "分析选项配置",
                    "properties": {
                      "generate_title": {
                        "type": "boolean",
                        "description": "是否生成标题",
                        "example": true
                      },
                      "generate_description": {
                        "type": "boolean",
                        "description": "是否生成描述",
                        "example": true
                      },
                      "generate_prompt": {
                        "type": "boolean",
                        "description": "是否生成AI绘画提示词",
                        "example": true
                      },
                      "generate_categories": {
                        "type": "boolean",
                        "description": "是否生成分类建议",
                        "example": true
                      },
                      "generate_tags": {
                        "type": "boolean",
                        "description": "是否生成标签建议",
                        "example": true
                      },
                      "max_categories": {
                        "type": "integer",
                        "description": "最大分类数量",
                        "example": 5
                      },
                      "max_tags": {
                        "type": "integer",
                        "description": "最大标签数量",
                        "example": 10
                      }
                    }
                  }
                }
              },
              "example": {
                "media_id": 38,
                "model_name": "qwen3-vl:2b-instruct-bf16",
                "options": {
                  "generate_title": true,
                  "generate_description": true,
                  "generate_prompt": true,
                  "generate_categories": true,
                  "generate_tags": true,
                  "max_categories": 5,
                  "max_tags": 10
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "成功创建分析任务",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "code": {
                      "type": "integer",
                      "example": 200
                    },
                    "message": {
                      "type": "string",
                      "example": "分析任务创建成功"
                    },
                    "data": {
                      "type": "object",
                      "properties": {
                        "analysis_id": {
                          "type": "integer",
                          "description": "分析记录ID",
                          "example": 1
                        },
                        "task_id": {
                          "type": "string",
                          "description": "任务ID",
                          "example": "abc123def456"
                        },
                        "status": {
                          "type": "string",
                          "description": "任务状态",
                          "example": "pending"
                        },
                        "media_info": {
                          "type": "object",
                          "description": "媒体文件信息",
                          "properties": {
                            "id": {"type": "integer", "example": 38},
                            "title": {"type": "string", "example": "sample.jpg"},
                            "file_type": {"type": "string", "example": "image"}
                          }
                        }
                      }
                    }
                  }
                },
                "example": {
                  "code": 200,
                  "message": "分析任务创建成功",
                  "data": {
                    "analysis_id": 1,
                    "task_id": "abc123def456",
                    "status": "pending",
                    "media_info": {
                      "id": 38,
                      "title": "sample.jpg",
                      "file_type": "image"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "请求参数错误",
            "content": {
              "application/json": {
                "example": {
                  "code": 400,
                  "message": "媒体文件ID不能为空",
                  "data": null
                }
              }
            }
          },
          "404": {
            "description": "媒体文件不存在",
            "content": {
              "application/json": {
                "example": {
                  "code": 404,
                  "message": "媒体文件不存在",
                  "data": null
                }
              }
            }
          }
        }
      }
    },
    "/api/ollama/analyze/status/": {
      "post": {
        "summary": "查询任务状态",
        "description": "查询指定分析任务的状态和进度",
        "tags": ["图片分析 API"],
        "parameters": [
          {
            "name": "Authorization",
            "in": "header",
            "description": "Bearer token 认证",
            "required": true,
            "example": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
            "schema": {"type": "string"}
          },
          {
            "name": "Content-Type",
            "in": "header",
            "description": "请求内容类型",
            "required": true,
            "example": "application/json",
            "schema": {"type": "string"}
          }
        ],
        "requestBody": {
          "description": "状态查询参数",
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["analysis_id"],
                "properties": {
                  "analysis_id": {
                    "type": "integer",
                    "description": "分析记录ID",
                    "example": 1
                  }
                }
              },
              "example": {
                "analysis_id": 1
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "成功获取任务状态",
            "content": {
              "application/json": {
                "example": {
                  "code": 200,
                  "message": "获取任务状态成功",
                  "data": {
                    "analysis_id": 1,
                    "status": "completed",
                    "progress": 100,
                    "task_id": "abc123def456",
                    "is_task_running": false,
                    "created_at": "2025-01-20T10:30:00Z",
                    "analyzed_at": "2025-01-20T10:35:00Z"
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/ollama/analyze/detail/": {
      "post": {
        "summary": "获取分析详情",
        "description": "获取指定分析任务的详细结果",
        "tags": ["图片分析 API"],
        "requestBody": {
          "description": "详情查询参数",
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["analysis_id"],
                "properties": {
                  "analysis_id": {
                    "type": "integer",
                    "description": "分析记录ID",
                    "example": 1
                  }
                }
              },
              "example": {
                "analysis_id": 1
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "成功获取分析详情",
            "content": {
              "application/json": {
                "example": {
                  "code": 200,
                  "message": "获取分析详情成功",
                  "data": {
                    "id": 1,
                    "media_info": {
                      "id": 38,
                      "title": "beautiful-landscape.jpg",
                      "file_type": "image",
                      "file_url": "/media/images/beautiful-landscape.jpg"
                    },
                    "status": "completed",
                    "model_used": "qwen3-vl:2b-instruct-bf16",
                    "title": "美丽风景画",
                    "description": "这是一幅展示自然美景的图片",
                    "prompt": "美丽的自然风景，山川河流，蓝天白云",
                    "suggested_categories_data": [
                      {"id": 1, "name": "风景", "description": "自然风景类图片"},
                      {"id": 2, "name": "艺术", "description": "艺术作品类"}
                    ],
                    "suggested_tags_data": [
                      {"id": 1, "name": "风景"},
                      {"id": 2, "name": "自然"},
                      {"id": 3, "name": "美丽"}
                    ],
                    "applied_to_media": true,
                    "task_progress": 100,
                    "created_at": "2025-01-20T10:30:00Z",
                    "analyzed_at": "2025-01-20T10:35:00Z"
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/ollama/analyze/apply/": {
      "post": {
        "summary": "应用分析结果",
        "description": "手动将分析结果应用到媒体文件",
        "tags": ["图片分析 API"],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["analysis_id"],
                "properties": {
                  "analysis_id": {
                    "type": "integer",
                    "description": "分析记录ID",
                    "example": 1
                  }
                }
              },
              "example": {
                "analysis_id": 1
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "成功应用分析结果",
            "content": {
              "application/json": {
                "example": {
                  "code": 200,
                  "message": "分析结果已成功应用到媒体文件",
                  "data": {
                    "analysis_id": 1,
                    "applied": true
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/ollama/analyze/retry/": {
      "post": {
        "summary": "重试失败任务",
        "description": "重新执行失败的分析任务",
        "tags": ["图片分析 API"],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["analysis_id"],
                "properties": {
                  "analysis_id": {
                    "type": "integer",
                    "description": "分析记录ID",
                    "example": 1
                  }
                }
              },
              "example": {
                "analysis_id": 1
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "成功重试任务",
            "content": {
              "application/json": {
                "example": {
                  "code": 200,
                  "message": "任务重试成功",
                  "data": {
                    "analysis_id": 1,
                    "task_id": "new_task_id_123",
                    "status": "pending"
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/ollama/analyze/delete/": {
      "post": {
        "summary": "删除分析记录",
        "description": "删除指定的分析记录",
        "tags": ["图片分析 API"],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["analysis_id"],
                "properties": {
                  "analysis_id": {
                    "type": "integer",
                    "description": "分析记录ID",
                    "example": 1
                  }
                }
              },
              "example": {
                "analysis_id": 1
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "成功删除分析记录",
            "content": {
              "application/json": {
                "example": {
                  "code": 200,
                  "message": "分析记录删除成功",
                  "data": null
                }
              }
            }
          }
        }
      }
    },
    "/api/ollama/analyze/list/": {
      "post": {
        "summary": "获取分析列表",
        "description": "获取分析记录列表，支持分页和状态筛选",
        "tags": ["图片分析 API"],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "page": {
                    "type": "integer",
                    "description": "页码",
                    "example": 1
                  },
                  "page_size": {
                    "type": "integer",
                    "description": "每页数量",
                    "example": 20
                  },
                  "status": {
                    "type": "string",
                    "description": "状态筛选 (pending, processing, completed, failed)",
                    "example": "completed"
                  }
                }
              },
              "example": {
                "page": 1,
                "page_size": 20,
                "status": "completed"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "成功获取分析列表",
            "content": {
              "application/json": {
                "example": {
                  "code": 200,
                  "message": "获取分析列表成功",
                  "data": {
                    "results": [
                      {
                        "id": 1,
                        "media_title": "beautiful-landscape.jpg",
                        "media_file_type": "image",
                        "status": "completed",
                        "model_used": "qwen3-vl:2b-instruct-bf16",
                        "created_at": "2025-01-20T10:30:00Z",
                        "analyzed_at": "2025-01-20T10:35:00Z"
                      }
                    ],
                    "count": 1,
                    "next": null,
                    "previous": null
                  }
                }
              }
            }
          }
        }
      }
    }
  },
  "tags": [
    {
      "name": "图片分析 API",
      "description": "AI图片分析相关接口，包括任务创建、状态查询、结果获取等功能"
    }
  ]
}